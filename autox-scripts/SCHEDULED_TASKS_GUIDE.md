# 예약 작업 시스템 가이드

**업데이트**: 2026-01-02  
**작성자**: Axon (Tech Lead)  
**버전**: 3.0.0 (Scheduled Tasks)

---

## 📋 시스템 개요

Laixi 예약 작업 기능을 AutoX.js에 구현한 시스템입니다.

### 주요 기능

1. **⏰ 예약 작업**: 시간 범위, 간격, 횟수 설정
2. **🔄 영상 순환**: 모든 영상 시청 완료 시 처음부터 반복
3. **🌾 Youtube Farm**: 검색어 기반 랜덤 비디오 시청
4. **😴 Sleep 패턴**: 활동 시간에 비례한 자동 휴식

---

## 🎯 워크플로우

```
┌─────────────────────────────────────────────────────────┐
│ 1. 예약 작업 시작 (09:00 ~ 23:59, 10분 간격)            │
└────────────┬────────────────────────────────────────────┘
             ↓
┌─────────────────────────────────────────────────────────┐
│ 2. 작업 선택 (30% Youtube Farm / 70% 오늘의 영상)       │
└──┬──────────┬───────────────────────────────────────────┘
   │          │
   │ 70%      │ 30%
   ↓          ↓
┌──────────┐ ┌─────────────────┐
│오늘의 영상│ │  Youtube Farm   │
│순환 재생  │ │(검색어 랜덤 시청)│
└────┬─────┘ └────┬────────────┘
     │            │
     └────┬───────┘
          ↓
┌─────────────────────────────────────────────────────────┐
│ 3. 영상 시청 (YouTube 앱)                               │
│   - URL 직접 열기 또는 검색                             │
│   - 시청 시간: 30~180초 (설정된 영상) / 50~80초 (Farm) │
│   - 좋아요 (30% / 10%)                                 │
│   - 댓글 (10% / 5%)                                     │
│   - 구독 (5% / 10%)                                     │
└────────────┬────────────────────────────────────────────┘
             ↓
┌─────────────────────────────────────────────────────────┐
│ 4. Sleep 패턴 (활동 : 휴식 = 1 : 0.5)                   │
│   활동 10분 → 휴식 5분                                  │
│   활동 30분 → 휴식 15분                                 │
└────────────┬────────────────────────────────────────────┘
             ↓
┌─────────────────────────────────────────────────────────┐
│ 5. 다음 작업 대기 (10분 간격)                           │
│   → 반복                                                │
└─────────────────────────────────────────────────────────┘
```

---

## ⚙️ 설정

### config/dev.json

```json
{
  "schedule": {
    "enabled": true,              // 예약 작업 활성화
    "startHour": 9,               // 시작 시간 (9시)
    "startMinute": 0,             // 시작 분 (0분)
    "endHour": 23,                // 종료 시간 (23시)
    "endMinute": 59,              // 종료 분 (59분)
    "intervalMinutes": 10,        // 간격 (10분마다 실행)
    "maxCount": 0,                // 최대 실행 횟수 (0 = 무제한)
    "youtube_farm_probability": 0.3  // Youtube Farm 확률 (30%)
  },
  "youtube_farm": {
    "min_play_time": 50,          // 최소 재생 시간 (초)
    "max_play_time": 80,          // 최대 재생 시간 (초)
    "like_probability": 0.1,      // 검토 확률 (10%)
    "subscribe_probability": 0.1, // 유사 확률 (10%)
    "comment_enabled": true,      // 댓글 활성화
    "video_interval_min": 5,      // 비디오 간격 최소 (초)
    "video_interval_max": 10      // 비디오 간격 최대 (초)
  },
  "sleep_pattern": {
    "ratio": 0.5,                 // 활동:휴식 비율 (1:0.5)
    "min_sleep_minutes": 3,       // 최소 휴식 시간 (분)
    "max_sleep_minutes": 30,      // 최대 휴식 시간 (분)
    "random_variance": 0.2        // 랜덤 변동 ±20%
  }
}
```

---

## 🚀 사용 방법

### 방법 1: 예약 작업 모드 (권장)

```bash
# 1. 설정 파일 편집
vi autox-scripts/config/dev.json

# 2. 예약 작업 활성화 확인
"schedule": { "enabled": true }

# 3. AutoX.js 실행
# main-scheduled.js 파일 실행

# 4. 로그 확인
[INFO] 📅 예약 작업 시작
[INFO] 🎬 작업 실행 시작
[INFO] 📺 오늘의 영상 시청 선택
[INFO] 👀 비디오 시청 시작
[INFO] ✅ 작업 실행 완료
[INFO] 😴 휴식 시작 (5분)
[INFO] ⏰ 다음 실행 대기 (10분)
```

### 방법 2: 기존 모드 (Receiver Only)

```bash
# main.js 실행 (기존 방식)
# ADB Broadcast만 수신
```

---

## 🔄 영상 순환 로직

### 순환 재생

```
오늘의 영상: [영상1, 영상2, 영상3]

실행 순서:
영상1 → 영상2 → 영상3 → 영상1 → 영상2 → ...
↑_____________________________|

무한 반복!
```

**로그**:
```
[INFO] ▶️  다음 영상 (1/3, 순환: 1) - 비트코인 급등 소식
[INFO] ▶️  다음 영상 (2/3, 순환: 1) - 이더리움 분석
[INFO] ▶️  다음 영상 (3/3, 순환: 1) - 리플 전망
[INFO] 🔄 영상 목록 순환 (순환: 1, 처음부터 다시 시작)
[INFO] ▶️  다음 영상 (1/3, 순환: 2) - 비트코인 급등 소식
```

---

## 🌾 Youtube Farm

### 검색어 기반 시청

```javascript
// 랜덤 키워드 풀
keywordPool = [
  '일상 브이로그',
  '요리 레시피',
  '여행 영상',
  '게임 플레이',
  '음악 추천',
  '운동 루틴',
  '영화 리뷰',
  'ASMR',
  '반려동물',
  '뷰티 팁'
];

// 세션 실행
1. 랜덤 키워드 선택
2. 검색 실행
3. 1~5위 중 랜덤 선택
4. 50~80초 시청
5. 10% 확률로 좋아요
6. 5% 확률로 댓글
7. 10% 확률로 구독
8. 5~10초 간격 후 다음 비디오
9. 세션 시간 종료까지 반복 (10~30분)
```

**로그**:
```
[INFO] 🌾 Youtube Farm 세션 시작 (키워드: 일상 브이로그, 600초)
[INFO] 👀 비디오 시청 시작 (65초, rank: 3)
[INFO] 👍 좋아요 클릭
[INFO] ⏰ 다음 비디오까지 대기 (7초)
[INFO] 👀 비디오 시청 시작 (72초, rank: 1)
[INFO] 💬 댓글 작성
[INFO] ✅ Youtube Farm 세션 완료 (비디오: 8, 시청: 540초, 좋아요: 2, 댓글: 1)
```

---

## 😴 Sleep 패턴

### 비율 기반 휴식

```
활동 : 휴식 = 1 : 0.5

예시:
- 활동 10분 → 휴식 5분 (±1분 랜덤)
- 활동 30분 → 휴식 15분 (±3분 랜덤)
- 활동 60분 → 휴식 30분 (최대치)
```

**로그**:
```
[INFO] 📊 활동 시간 기록 (600초, 총 10분)
[INFO] 😴 휴식 시작 (활동: 10분, 휴식: 5분, 비율: 1:0.5)
[DEBUG] 😴 휴식 중... (경과: 1분, 남은: 4분)
[DEBUG] 😴 휴식 중... (경과: 2분, 남은: 3분)
...
[INFO] ✅ 휴식 완료 (5분 12초, 총 휴식: 5분)
```

### 자연스러운 패턴

```
시간      활동      휴식
09:00   🎬 영상1   
09:05   😴 2분    
09:07   🎬 영상2
09:12   😴 2분
09:14   🌾 Farm   (15분)
09:29   😴 7분    (활동 비례)
09:36   🎬 영상3
09:41   😴 2분
...
23:59   종료
```

**장점**:
- ✅ 사람처럼 자연스러운 활동
- ✅ 과도한 활동 방지
- ✅ 계정 밴 위험 감소
- ✅ 실제 사용자 패턴 시뮬레이션

---

## 🎯 예약 작업 설정 예시

### 예시 1: 일반 패턴 (하루 종일)

```json
{
  "schedule": {
    "enabled": true,
    "startHour": 9,              // 오전 9시 시작
    "startMinute": 0,
    "endHour": 23,               // 오후 11시 59분 종료
    "endMinute": 59,
    "intervalMinutes": 10,       // 10분 간격
    "maxCount": 0,               // 무제한
    "youtube_farm_probability": 0.3
  }
}
```

**실행 시간**: 09:00, 09:10, 09:20, ..., 23:50  
**총 실행**: 약 90회 (15시간 × 6회/시간)

### 예시 2: 출근 시간 집중 패턴

```json
{
  "schedule": {
    "enabled": true,
    "startHour": 8,              // 오전 8시 시작
    "startMinute": 0,
    "endHour": 10,               // 오전 10시 종료
    "endMinute": 0,
    "intervalMinutes": 5,        // 5분 간격 (집중 실행)
    "maxCount": 24,              // 24회 실행
    "youtube_farm_probability": 0.5
  }
}
```

**실행 시간**: 08:00, 08:05, 08:10, ..., 09:55  
**총 실행**: 24회 (2시간 × 12회/시간)

### 예시 3: 저녁 시간 패턴

```json
{
  "schedule": {
    "enabled": true,
    "startHour": 18,             // 오후 6시 시작
    "startMinute": 0,
    "endHour": 23,               // 오후 11시 종료
    "endMinute": 0,
    "intervalMinutes": 15,       // 15분 간격 (여유 있게)
    "maxCount": 20,
    "youtube_farm_probability": 0.2
  }
}
```

**실행 시간**: 18:00, 18:15, 18:30, ..., 23:00  
**총 실행**: 20회

---

## 🌾 Youtube Farm 상세

### 목적

**일상 패턴 시뮬레이션** - 실제 사용자처럼 다양한 컨텐츠 시청

### 활동

```
1. 랜덤 키워드 선택
   - 일상 브이로그, 요리, 여행, 게임, 음악, 운동 등
   
2. 검색 실행
   
3. 1~5위 중 랜덤 선택
   
4. 50~80초 시청
   
5. 인터랙션 (확률적)
   - 좋아요: 10%
   - 댓글: 5%
   - 구독: 10%
   
6. 5~10초 간격
   
7. 다음 비디오
   
8. 세션 종료까지 반복 (10~30분)
```

### 통계

```javascript
{
  keyword: "일상 브이로그",
  videos_watched: 8,
  total_watch_time: 540,  // 9분
  likes_given: 2,
  comments_written: 1,
  subscriptions: 1,
  started_at: "2026-01-02T10:00:00Z",
  ended_at: "2026-01-02T10:09:00Z"
}
```

---

## 😴 Sleep 패턴 상세

### 계산 공식

```python
휴식시간 = 활동시간 × 비율 × (1 ± 랜덤변동)

예시 (비율 0.5, 변동 ±20%):
- 활동 10분 → 휴식 4~6분 (5분 ± 1분)
- 활동 30분 → 휴식 12~18분 (15분 ± 3분)
- 활동 60분 → 휴식 24~36분 (30분, 최대치)
```

### 제한

- **최소 휴식**: 3분
- **최대 휴식**: 30분

### 장점

```
✅ 자연스러운 사용 패턴
   - 활동 → 휴식 → 활동 (사람처럼)

✅ 과부하 방지
   - 연속 활동 제한
   - 계정 안전성 확보

✅ 일상 패턴 구축
   - Youtube Farm과 결합
   - 다양한 컨텐츠 + 적절한 휴식
```

---

## 📊 실행 예시

### 하루 타임라인

```
시간   | 활동                      | 휴식      | 누적 활동 | 누적 휴식
-------|--------------------------|-----------|----------|----------
09:00  | 🎬 영상1 (5분)           | 😴 2분    | 5분      | 2분
09:07  | 🌾 Farm (20분)           | 😴 10분   | 25분     | 12분
09:37  | 🎬 영상2 (4분)           | 😴 2분    | 29분     | 14분
09:43  | 🎬 영상3 (6분)           | 😴 3분    | 35분     | 17분
09:52  | 🌾 Farm (25분)           | 😴 12분   | 60분     | 29분
10:29  | 🎬 영상1 (순환, 5분)     | 😴 2분    | 65분     | 31분
...
23:50  | 🎬 영상N (4분)           | 😴 2분    | 800분    | 400분
23:59  | 예약 작업 종료           |           |          |

최종: 활동 13시간 20분, 휴식 6시간 40분 (비율 1:0.5)
```

---

## 🎮 시나리오별 설정

### 시나리오 A: 집중 활동 (높은 빈도)

```json
{
  "schedule": {
    "intervalMinutes": 5,         // 5분 간격 (빠른 실행)
    "youtube_farm_probability": 0.1  // Farm 10% (작업 집중)
  },
  "sleep_pattern": {
    "ratio": 0.3                  // 활동:휴식 = 1:0.3 (짧은 휴식)
  }
}
```

**결과**: 빠른 작업 처리, 짧은 휴식

### 시나리오 B: 자연스러운 패턴 (균형)

```json
{
  "schedule": {
    "intervalMinutes": 10,        // 10분 간격
    "youtube_farm_probability": 0.3  // Farm 30%
  },
  "sleep_pattern": {
    "ratio": 0.5                  // 활동:휴식 = 1:0.5 (균형)
  }
}
```

**결과**: 자연스러운 활동, 균형 잡힌 휴식

### 시나리오 C: 여유로운 패턴 (안전)

```json
{
  "schedule": {
    "intervalMinutes": 15,        // 15분 간격 (여유)
    "youtube_farm_probability": 0.5  // Farm 50% (다양성)
  },
  "sleep_pattern": {
    "ratio": 0.7                  // 활동:휴식 = 1:0.7 (긴 휴식)
  }
}
```

**결과**: 느긋한 활동, 긴 휴식 (가장 안전)

---

## 🧪 테스트

### 1. 설정 확인

```bash
# config/dev.json 확인
cat autox-scripts/config/dev.json | grep -A 10 schedule
```

### 2. 로컬 시뮬레이터

```bash
# Gateway 없이 로컬 테스트
node autox-scripts/tests/simulator-scheduled.js
```

### 3. Gateway 연동 테스트

```bash
# 1. Gateway 실행
cd gateway && npm run dev:all

# 2. 오늘의 영상 등록 (Dashboard)
http://localhost:3000/dashboard/youtube-upload

# 3. 디바이스 할당
python scripts/local/local-orchestrate_video_assignments-cli.py

# 4. AutoX.js 실행
main-scheduled.js 실행

# 5. 로그 확인
[INFO] 📋 오늘의 영상 목록 로드 중...
[INFO] ✅ 영상 목록 로드 완료 (3개)
[INFO] 📅 예약 작업 시작 (09:00~23:59, 10분 간격)
```

---

## 📈 통계 조회

### AutoX.js 로그

```
[INFO] 📊 세션 통계
  queue: {
    totalVideos: 3,
    currentIndex: 1,
    completedCount: 25,
    cycleCount: 8
  }
  sleep: {
    totalActivityMinutes: 250,
    totalSleepMinutes: 125,
    ratio: 0.50,
    lastSleepTime: "23:45:30"
  }
```

### Gateway API

```bash
# 디바이스별 통계
curl http://localhost:3100/api/youtube/stats/PC_01_001

# 응답:
{
  "success": true,
  "device_id": "PC_01_001",
  "stats": {
    "total_tasks": 25,
    "completed": 22,
    "pending": 3,
    "failed": 0,
    "total_likes": 6,
    "total_comments": 2,
    "total_subscriptions": 1
  }
}
```

---

## 🔧 문제 해결

### 문제: "오늘 등록된 영상 없음"

**원인**: 오늘 날짜에 할당된 영상이 없음

**해결**:
```bash
# Dashboard에서 영상 등록
http://localhost:3000/dashboard/youtube-upload

# 또는 Google Sheets에 입력 후 동기화
python scripts/local/local-sync_youtube_gsheet-cli.py --mode to-supabase
```

### 문제: Youtube Farm만 계속 실행됨

**원인**: 오늘의 영상이 없거나 `youtube_farm_probability`가 너무 높음

**해결**:
```json
{
  "schedule": {
    "youtube_farm_probability": 0.2  // 30% → 20%로 낮춤
  }
}
```

### 문제: 휴식 시간이 너무 길다

**원인**: `sleep_pattern.ratio`가 높음

**해결**:
```json
{
  "sleep_pattern": {
    "ratio": 0.3,            // 0.5 → 0.3 (휴식 단축)
    "max_sleep_minutes": 15  // 최대 30분 → 15분
  }
}
```

---

## 📚 모듈 구조

```
autox-scripts/
├── main-scheduled.js            ⭐ 신규 (예약 작업)
├── main.js                      (기존, Receiver만)
├── modules/
│   ├── scheduler.js            ⭐ 신규 (예약 스케줄러)
│   ├── video-queue.js          ⭐ 신규 (영상 순환)
│   ├── youtube-farm.js         ⭐ 신규 (검색어 시청)
│   ├── sleep-pattern.js        ⭐ 신규 (Sleep 패턴)
│   ├── api.js                  (업데이트: getTodayVideos 추가)
│   ├── youtube.js              (기존)
│   ├── human.js                (기존)
│   ├── receiver.js             (기존)
│   └── logger.js               (기존)
└── config/
    └── dev.json                (업데이트: 새 설정 추가)
```

---

## 🚀 배포

### 각 PC 노드에 배포

```bash
# PC_01 ~ PC_05에서 각각 실행

# 1. 설정 파일 수정 (device.id)
vi autox-scripts/config/dev.json
{
  "device": {
    "id": "PC_01_001",  # ← 각 디바이스별로 변경
    ...
  }
}

# 2. AutoX.js 앱에서 실행
# main-scheduled.js 선택 → 실행

# 3. 600대 동시 실행
# 각 PC의 120대 디바이스에서 동시 실행
```

---

## 📊 예상 결과

### 하루 활동 (디바이스 1대 기준)

```
예약 작업: 09:00 ~ 23:59 (15시간)
간격: 10분
총 실행: 약 90회

활동 구성:
- 오늘의 영상: 63회 (70%)
- Youtube Farm: 27회 (30%)

총 활동 시간: 약 450분 (7.5시간)
총 휴식 시간: 약 225분 (3.75시간)

인터랙션:
- 좋아요: 약 25회
- 댓글: 약 10회
- 구독: 약 5회
```

### 600대 디바이스 기준 (하루)

```
총 실행: 54,000회 (90회 × 600대)
총 시청: 약 450,000분 (7,500시간)

인터랙션:
- 좋아요: 약 15,000회
- 댓글: 약 6,000회
- 구독: 약 3,000회
```

---

## 🎉 요약

### ✅ 구현된 기능

1. **예약 작업 시스템**
   - 시간 범위 설정 (시작~종료)
   - 간격 설정 (분 단위)
   - 횟수 제한 (무제한 가능)
   - 자동 반복 실행

2. **영상 순환 로직**
   - 오늘의 영상 목록 로드
   - 순차 재생 (끝나면 처음부터)
   - 날짜 변경 시 자동 초기화

3. **Youtube Farm**
   - 검색어 기반 시청
   - 랜덤 비디오 선택 (1~5위)
   - 다양한 키워드 풀
   - 세션 단위 실행 (10~30분)

4. **Sleep 패턴**
   - 활동 시간 비례 휴식 (1:0.5)
   - 랜덤 변동 (±20%)
   - 최소/최대 제한 (3~30분)
   - 자연스러운 패턴 시뮬레이션

### 🎯 사용 시나리오

**일반 사용자 (600대 운영)**:
```bash
# 1. 예약 작업 활성화 (config/dev.json)
# 2. 모든 디바이스에서 main-scheduled.js 실행
# 3. Dashboard에서 영상 등록
# 4. 자동으로 시청 + Farm + Sleep
```

**결과**: 자연스러운 활동 패턴, 계정 안전성 확보, 다양한 컨텐츠 시청

---

**작성**: Axon (Tech Lead)  
**버전**: 3.0.0  
**업데이트**: 2026-01-02
