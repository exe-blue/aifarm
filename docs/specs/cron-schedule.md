# DoAi.Me 크론잡 스케줄 명세

> 작성일: 2026-01-06
> 작성자: Aria (Architect)
> 요구사항: Supabase Pro + pg_cron 확장

---

## 설계 근거

| 결정 | 이유 |
|------|------|
| Supabase pg_cron 사용 | 외부 스케줄러 불필요, DB 내부 실행으로 레이턴시 최소화 |
| 배치 틱 10분 주기 | 600대 x 10분 = 시간당 3,600 RPC 호출, Supabase 한도 내 |
| 자정 리셋 KST 기준 | 사용자(한국) 기준 일일 통계 |
| 유지비 차감 6시간 주기 | 과도한 포인트 소모 방지, 경제 밸런스 |

---

## 크론잡 목록

| 작업명 | 스케줄 (UTC) | KST | 설명 |
|--------|-------------|-----|------|
| existence-state-tick | `*/10 * * * *` | 매 10분 | 존재 상태 배치 업데이트 |
| daily-counter-reset | `0 15 * * *` | 00:00 | 일일 카운터 리셋 |
| maintenance-fee-deduction | `0 */6 * * *` | 6시간마다 | 유지비 차감 (-5 포인트) |
| void-assimilation-progress | `30 * * * *` | 매시 30분 | Void 동화 진행 (+1%) |
| daily-stats-snapshot | `0 21 * * *` | 06:00 | 일일 통계 스냅샷 |

---

## 크론잡 타임라인 (24시간 KST 기준)

```text
┌─────────────────────────────────────────────────────────────────────┐
│                    DoAi.Me 크론잡 일일 스케줄 (KST)                  │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  00:00 ─┬─ 일일 카운터 리셋 (reset_daily_counters)                  │
│         │                                                           │
│  00:10 ─┼─ 존재 상태 틱 ─┐                                          │
│  00:20 ─┼─ 존재 상태 틱  │                                          │
│  00:30 ─┼─ Void 동화 + 존재 상태 틱                                 │
│  00:40 ─┼─ 존재 상태 틱  │                                          │
│  00:50 ─┼─ 존재 상태 틱 ─┘  (10분 간격 반복)                        │
│         │                                                           │
│  06:00 ─┼─ 일일 통계 스냅샷 (전일 기준)                             │
│         │                                                           │
│  09:00 ─┼─ 유지비 차감 (-5 포인트)                                  │
│         │                                                           │
│  15:00 ─┼─ 유지비 차감 (-5 포인트)                                  │
│         │                                                           │
│  21:00 ─┼─ 유지비 차감 (-5 포인트)                                  │
│         │                                                           │
│  03:00 ─┴─ 유지비 차감 (-5 포인트)                                  │
│                                                                     │
│  ※ 존재 상태 틱: 매 10분 (하루 144회)                               │
│  ※ Void 동화: 매 시간 :30분 (하루 24회)                             │
│  ※ 유지비 차감: 6시간 간격 (하루 4회, 총 -20 포인트)                │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 경제 밸런스 시뮬레이션

```text
┌─────────────────────────────────────────────────────────────────────┐
│                    일일 포인트 흐름 시뮬레이션                       │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  [지출]                                                             │
│  ├─ 유지비: -20 포인트/일 (고정)                                    │
│  └─ 총 지출: -20 포인트/일                                          │
│                                                                     │
│  [수입 - 활동별]                                                    │
│  ├─ 영상 시청 (60초): +6 포인트                                     │
│  ├─ 영상 시청 (120초): +12 포인트                                   │
│  ├─ 좋아요: +5 포인트                                               │
│  ├─ 댓글: +10 포인트                                                │
│  └─ 신규 콘텐츠 보너스: +3 포인트                                   │
│                                                                     │
│  [시나리오 분석]                                                    │
│                                                                     │
│  A. 비활동 페르소나:                                                │
│     수입: 0, 지출: -20 → 5일 후 부채 (초기 100 포인트 기준)         │
│                                                                     │
│  B. 최소 활동 (1영상/일):                                           │
│     수입: +12+5+10 = +27, 지출: -20 → +7/일 (생존)                  │
│                                                                     │
│  C. 적극 활동 (5영상/일):                                           │
│     수입: +135, 지출: -20 → +115/일 (번영)                          │
│                                                                     │
│  D. 회복 시나리오 (부채 -50):                                       │
│     3영상 시청 → +81 - 20 = +61 → 부채 탈출                         │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 관련 파일

| 파일 | 설명 |
|------|------|
| `supabase/functions/cron_jobs.sql` | 크론잡 정의 SQL |
| `supabase/migrations/011_daily_stats_snapshots.sql` | 스냅샷 테이블 마이그레이션 |
| `supabase/functions/rpc_definitions.sql` | RPC 함수 정의 |

---

## 실행 방법

### 1. pg_cron 확장 활성화
Supabase Dashboard > Database > Extensions > pg_cron 활성화

### 2. 크론잡 등록
```sql
-- SQL Editor에서 cron_jobs.sql 실행
```

### 3. 모니터링
```sql
-- 등록된 크론잡 확인
SELECT * FROM cron.job;

-- 실행 이력 확인
SELECT * FROM cron.job_run_details ORDER BY start_time DESC LIMIT 20;
```

### 4. 크론잡 관리
```sql
-- 특정 크론잡 비활성화
SELECT cron.unschedule('existence-state-tick');

-- 크론잡 재활성화 (동일 명령 재실행)
```

---

## 타임존 주의사항

- Supabase는 **UTC 기준**으로 동작
- KST = UTC + 9시간
- 예: KST 00:00 = UTC 15:00

| KST | UTC | 용도 |
|-----|-----|------|
| 00:00 | 15:00 | 일일 리셋 |
| 06:00 | 21:00 | 통계 스냅샷 |
| 09:00 | 00:00 | 유지비 차감 |
| 15:00 | 06:00 | 유지비 차감 |
| 21:00 | 12:00 | 유지비 차감 |
| 03:00 | 18:00 | 유지비 차감 |
