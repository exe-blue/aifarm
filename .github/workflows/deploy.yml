# ============================================
# DoAi.Me CI/CD Pipeline
# ============================================
# Triggers:
#   - Push to main branch
#   - Manual dispatch
#
# Jobs:
#   1. Deploy to Vultr (Docker services)
#   2. Vercel auto-deploys via GitHub integration
# ============================================

name: Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      deploy_vultr:
        description: 'Deploy to Vultr'
        required: false
        default: 'true'
        type: boolean

env:
  VULTR_HOST: 158.247.210.152
  VULTR_USER: root

jobs:
  # ==================== Vultr Deployment ====================
  deploy-vultr:
    name: Deploy to Vultr
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event.inputs.deploy_vultr == 'true'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.VULTR_SSH_KEY }}

      - name: Add Vultr to known hosts
        run: |
          mkdir -p ~/.ssh
          # IP ì£¼ì†Œë¡œ known_hosts ì¶”ê°€
          ssh-keyscan -H -t rsa,ed25519 158.247.210.152 >> ~/.ssh/known_hosts 2>/dev/null || \
          echo "âš ï¸  Known hosts ì¶”ê°€ ì‹¤íŒ¨, SSHëŠ” StrictHostKeyChecking=noë¡œ ì§„í–‰"

      - name: Deploy to Vultr
        run: |
          ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
            root@158.247.210.152 << 'ENDSSH'
            set -e
            
            echo "=========================================="
            echo "ğŸš€ DoAi.Me Vultr ë°°í¬ ì‹œì‘"
            echo "=========================================="
            
            # í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ë¡œ ì´ë™
            cd /opt/doai-me || { echo "âŒ /opt/doai-me ë””ë ‰í† ë¦¬ ì—†ìŒ"; exit 1; }
            
            # Git pull
            echo "ğŸ“¥ ìµœì‹  ì½”ë“œ ê°€ì ¸ì˜¤ê¸°..."
            git fetch origin main
            git reset --hard origin/main
            
            # Orchestrator ì¬ì‹œì‘ (DockerëŠ” ìˆ˜ë™ ì„¤ì • í•„ìš”)
            echo "ğŸ§  Orchestrator ì¬ì‹œì‘..."
            if systemctl is-active --quiet doai-orchestrator; then
              systemctl restart doai-orchestrator
              echo "âœ… Orchestrator ì¬ì‹œì‘ ì™„ë£Œ"
            else
              echo "âš ï¸  Orchestrator ì„œë¹„ìŠ¤ ì—†ìŒ (ìˆ˜ë™ ì„¤ì • í•„ìš”)"
            fi
            
            # í—¬ìŠ¤ì²´í¬
            echo "ğŸ” í—¬ìŠ¤ì²´í¬..."
            sleep 3
            
            # Orchestrator ì²´í¬
            if curl -sf http://localhost:8080/health > /dev/null 2>&1; then
              echo "âœ… Orchestrator: ì •ìƒ"
            else
              echo "âš ï¸ Orchestrator: í™•ì¸ í•„ìš”"
            fi
            
            echo ""
            echo "=========================================="
            echo "âœ… ë°°í¬ ì™„ë£Œ!"
            echo "=========================================="
          ENDSSH

  # ==================== Notify ====================
  notify:
    name: Notify Deployment
    runs-on: ubuntu-latest
    needs: [deploy-vultr]
    if: always()
    
    steps:
      - name: Deployment Summary
        run: |
          echo "=========================================="
          echo "ğŸ“‹ ë°°í¬ ìš”ì•½"
          echo "=========================================="
          echo "Branch: ${{ github.ref_name }}"
          echo "Commit: ${{ github.sha }}"
          echo "Author: ${{ github.actor }}"
          echo ""
          echo "Vultr: ${{ needs.deploy-vultr.result }}"
          echo "Vercel: Auto-deployed via GitHub integration"
          echo "=========================================="

